#!/usr/bin/env node

/**
 * Guardian Hook Setup Script
 * 
 * Installs pre-commit hook to enforce protected files policy
 * Run after: npm install
 * 
 * Usage:
 *   node bin/setup-guardian-hooks.cjs                     # Install hooks
 *   node bin/setup-guardian-hooks.cjs --dry-run           # Preview changes (no-op)
 *   node bin/setup-guardian-hooks.cjs --force             # Overwrite existing
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Parse arguments
const args = process.argv.slice(2);
const isDryRun = args.includes('--dry-run');
const isForce = args.includes('--force');

const gitDir = path.join(__dirname, '..', '.git');
const hookDir = path.join(gitDir, 'hooks');
const preCommitHookPath = path.join(hookDir, 'pre-commit');
const guardianScript = path.join(__dirname, 'guardian-protected-files-hook.cjs');

/**
 * Check if .git/ exists (blocker if not)
 */
function checkGitRepo() {
  if (!fs.existsSync(gitDir)) {
    console.error(`âŒ FATAL: Not a git repository!`);
    console.error(`   Expected to find: ${gitDir}`);
    console.error(`   Guardian hooks can only be installed in a git repository.`);
    process.exit(2);  // Exit code 2 = blocker
  }
}

/**
 * Create .git/hooks directory if needed
 */
function ensureHookDir() {
  if (!fs.existsSync(hookDir)) {
    if (isDryRun) {
      console.log(`[DRY-RUN] Would create: ${hookDir}`);
    } else {
      fs.mkdirSync(hookDir, { recursive: true });
      console.log(`âœ… Created ${hookDir}`);
    }
  }
}

/**
 * Check if pre-commit hook already exists
 */
function hookExists() {
  return fs.existsSync(preCommitHookPath);
}

/**
 * Install pre-commit hook
 */
function installPreCommitHook() {
  const hookContent = `#!/bin/sh
# Generated by Guardian Hook Setup
# DO NOT EDIT - This file is auto-generated

node ${guardianScript}
exit_code=$?

if [ $exit_code -eq 2 ]; then
  exit 1  # Prevent commit on blocker
fi

exit 0
`;

  if (hookExists() && !isForce) {
    console.warn(`âš ï¸  Pre-commit hook already exists at ${preCommitHookPath}`);
    console.warn(`   Use --force to overwrite`);
    return false;
  }

  if (isDryRun) {
    console.log(`[DRY-RUN] Would write hook to: ${preCommitHookPath}`);
    console.log(`[DRY-RUN] Would chmod +x the hook`);
  } else {
    fs.writeFileSync(preCommitHookPath, hookContent);
    fs.chmodSync(preCommitHookPath, 0o755);
    console.log(`âœ… Installed pre-commit hook at ${preCommitHookPath}`);
  }
  
  return true;
}

/**
 * Verify installation
 */
function verifyInstallation() {
  if (!fs.existsSync(preCommitHookPath)) {
    return false;
  }

  const stats = fs.statSync(preCommitHookPath);
  const isExecutable = (stats.mode & 0o111) !== 0;

  if (isExecutable) {
    console.log('âœ… Pre-commit hook is executable and ready');
    return true;
  } else {
    console.warn('âš ï¸  Pre-commit hook exists but is not executable');
    if (!isDryRun) {
      fs.chmodSync(preCommitHookPath, 0o755);
      console.log('âœ… Fixed executable permission');
    }
    return true;
  }
}

/**
 * Main setup
 */
function setup() {
  const mode = isDryRun ? '[DRY-RUN MODE]' : '';
  console.log(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
  console.log(`â•‘          ğŸ›¡ï¸  Guardian Hook Setup - Protected Files ${mode.padEnd(4)}â•‘`);
  console.log(`â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);

  try {
    // Step 1: Check if git repo
    checkGitRepo();
    console.log(`âœ… Git repository found: ${gitDir}`);

    // Step 2: Ensure hook directory
    ensureHookDir();

    // Step 3: Install hook
    const installed = installPreCommitHook();

    // Step 4: Verify (only if we installed)
    if (installed && !isDryRun) {
      verifyInstallation();
    }

    if (!isDryRun && installed) {
      console.log(`
âœ… Guardian protected files policy is now ACTIVE.

Any attempt to commit changes to protected files without
the --ack-protected flag will be BLOCKED.

Protected files:
  â€¢ CERBER.md
  â€¢ .cerber/contract.yml
  â€¢ bin/cerber-guardian
  â€¢ src/guardian/**
  â€¢ src/contracts/**
  â€¢ src/core/Orchestrator.ts
  â€¢ package.json
  â€¢ tsconfig.json

To bypass (with acknowledgment):
  git commit -m "..." --ack-protected
  git commit -m "..." --owner-ack "reason"

`);
      process.exit(0);
    } else if (isDryRun) {
      console.log(`\n[DRY-RUN] No changes made. Re-run without --dry-run to install.\n`);
      process.exit(0);
    } else {
      console.log(`\nâš ï¸  Hook already exists. Use --force to overwrite.\n`);
      process.exit(0);
    }
  } catch (error) {
    console.error(`âŒ Setup failed: ${error.message}`);
    process.exit(1);
  }
}

// Run setup
setup();
