#!/usr/bin/env node

/**
 * Guardian Hook Setup Script
 * 
 * Installs pre-commit hook to enforce protected files policy
 * Run after: npm install
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const hookDir = path.join(__dirname, '..', '.git', 'hooks');
const preCommitHookPath = path.join(hookDir, 'pre-commit');
const guardianScript = path.join(__dirname, 'guardian-protected-files-hook.cjs');

/**
 * Create .git/hooks directory if needed
 */
function ensureHookDir() {
  if (!fs.existsSync(hookDir)) {
    fs.mkdirSync(hookDir, { recursive: true });
    console.log(`âœ… Created ${hookDir}`);
  }
}

/**
 * Install pre-commit hook
 */
function installPreCommitHook() {
  const hookContent = `#!/bin/sh
# Generated by Guardian Hook Setup
# DO NOT EDIT - This file is auto-generated

node ${guardianScript}
exit_code=$?

if [ $exit_code -eq 2 ]; then
  exit 1  # Prevent commit on blocker
fi

exit 0
`;

  fs.writeFileSync(preCommitHookPath, hookContent);
  fs.chmodSync(preCommitHookPath, 0o755);

  console.log(`âœ… Installed pre-commit hook at ${preCommitHookPath}`);
}

/**
 * Verify installation
 */
function verifyInstallation() {
  if (fs.existsSync(preCommitHookPath)) {
    const stats = fs.statSync(preCommitHookPath);
    const isExecutable = (stats.mode & 0o111) !== 0;

    if (isExecutable) {
      console.log('âœ… Pre-commit hook is executable and ready');
      return true;
    } else {
      console.warn('âš ï¸  Pre-commit hook exists but is not executable');
      fs.chmodSync(preCommitHookPath, 0o755);
      console.log('âœ… Fixed executable permission');
      return true;
    }
  }

  return false;
}

/**
 * Main setup
 */
function setup() {
  console.log(`\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—`);
  console.log(`â•‘          ğŸ›¡ï¸  Guardian Hook Setup - Protected Files           â•‘`);
  console.log(`â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`);

  try {
    ensureHookDir();
    installPreCommitHook();
    const verified = verifyInstallation();

    if (verified) {
      console.log(`
âœ… Guardian protected files policy is now ACTIVE.

Any attempt to commit changes to protected files without
the --ack-protected flag will be BLOCKED.

Protected files:
  â€¢ CERBER.md
  â€¢ .cerber/contract.yml
  â€¢ bin/cerber-guardian
  â€¢ src/guardian/**
  â€¢ src/contracts/**
  â€¢ src/core/Orchestrator.ts
  â€¢ package.json
  â€¢ tsconfig.json

To bypass (with acknowledgment):
  git commit -m "..." --ack-protected
  git commit -m "..." --owner-ack "reason"

`);
    }
  } catch (error) {
    console.error(`âŒ Setup failed: ${error.message}`);
    process.exit(1);
  }
}

// Run setup
setup();
