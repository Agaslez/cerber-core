# Cerber Core: One Truth CI/CD Architecture
# Source of truth for gates, protected files, and test organization
# This contract drives automatic generation of CERBER.md and workflows
# DO NOT EDIT GENERATED FILES - edit this contract instead, then run: npm run cerber:generate

contractVersion: 2
name: cerber-core-contract
version: 2.0.0

metadata:
  description: 'One Truth: CI gates, test tags, protected files'
  author: 'Cerber Core'
  tags:
    - nodejs
    - npm
    - ci-gates
    - test-organization
  generatedFilesHeader: 'AUTO-GENERATED BY CERBER — DO NOT EDIT'

# ============================================
# GOAL 1: CI Gate Separation (FAST vs HEAVY)
# ============================================
gates:
  fast:
    name: 'PR Fast Checks'
    description: 'Fast gates for PR validation (< 5 min)'
    requiredOn: pull_request
    timeout: 300  # 5 minutes
    jobs:
      - name: lint_and_typecheck
        description: 'ESLint + TypeScript type check'
        command: 'npm run lint && npx tsc --noEmit'
      - name: build_and_unit
        description: 'Build + unit tests only'
        command: 'npm run build && npm run test:fast'
    commands:
      - npm ci
      - npm run build
      - npm run lint
      - npm run test:fast
    testFilters:
      - '@fast'
    excludeTests:
      - '**/cli-signals.test.ts'
      - '**/npm-pack-install.test.ts'
      - '**/e2e/**'
  
  heavy:
    name: 'Heavy Verification'
    description: 'Heavy gates for main branch and nightly runs'
    requiredOn: 
      - push  # main branch only
    optionalOn:
      - pull_request  # Available but not required for PR
    timeout: 1800  # 30 minutes
    jobs:
      - name: integration_tests
        description: 'Real git ops, file discovery, adapters'
        command: 'npm run test:integration'
      - name: e2e_tests
        description: 'npm-pack, install-from-tarball, multi-mode'
        command: 'npm run test:e2e'
      - name: signals_tests
        description: 'Process signal handling'
        command: 'npm run test:signals'
    testTags:
      - '@integration'
      - '@e2e'
      - '@signals'
    retries: 1
    retryTimeoutIncrement: 5000

# ============================================
# GOAL 2: Test Organization with Tags
# ============================================
testTags:
  fast:
    name: 'Fast Unit Tests'
    description: 'Unit tests, deterministic, <1s each'
    command: 'npm run test:fast'
    timeout: 1000
    maxRetries: 0
    jestArgs: '--testNamePattern="@fast"'
    examples:
      - 'schema validation'
      - 'parser unit tests'
      - 'utility functions'
  
  integration:
    name: 'Integration Tests'
    description: 'Real git ops, file discovery, real adapters'
    command: 'npm run test:integration'
    timeout: 5000
    maxRetries: 0
    jestArgs: '--testNamePattern="@integration"'
    includes:
      - 'orchestrator real git'
      - 'file discovery with globs'
      - 'adapter real tool execution'
    exclusions:
      - 'mocked dependencies'
  
  e2e:
    name: 'End-to-End Tests'
    description: 'npm-pack, install-from-tarball, multi-mode'
    command: 'npm run test:e2e'
    timeout: 30000
    maxRetries: 1
    jestArgs: '--testNamePattern="@e2e"'
    examples:
      - 'npm pack integration'
      - 'install from tarball'
      - 'multi-mode validation'
  
  signals:
    name: 'Signal Handling Tests'
    description: 'Process signal handling (SIGINT, SIGTERM)'
    command: 'npm run test:signals'
    timeout: 10000
    maxRetries: 1
    jestArgs: '--testNamePattern="@signals"'
    includes:
      - 'SIGINT graceful shutdown'
      - 'SIGTERM cleanup'
      - 'zombie process prevention'

# ============================================
# GOAL 3: Protected Files Policy
# ============================================
protectedFiles:
  enabled: true
  requireOwnerAck: true
  description: 'Prevent drift between contract and actual files'
  
  autoGeneratedPatterns:
    - path: CERBER.md
      source: '.cerber/contract.yml'
      command: 'npm run cerber:generate'
      protected: true
    
    - path: .github/workflows/cerber-pr-fast.yml
      source: '.cerber/contract.yml'
      command: 'npm run cerber:generate'
      protected: true
    
    - path: .github/workflows/cerber-main-heavy.yml
      source: '.cerber/contract.yml'
      command: 'npm run cerber:generate'
      protected: true
    
    - path: .github/CODEOWNERS
      source: '.cerber/contract.yml'
      command: 'npm run cerber:generate'
      protected: true
      onlyIfTeamMode: true
  
  manualEditPatterns:
    - path: '.cerber/contract.yml'
      description: 'Source of truth - edit directly'
      protected: false
    
    - path: 'src/cli/generator.ts'
      description: 'CLI command for generation'
      protected: false
    
    - path: 'src/cli/drift-checker.ts'
      description: 'CLI command for drift detection'
      protected: false
    
    - path: 'src/cli/guardian.ts'
      description: 'Pre-commit guardian'
      protected: false
    
    - path: 'src/cli/doctor.ts'
      description: 'Health check command'
      protected: false
  
  criticalPatterns:
    - CERBER.md
    - .cerber/contract.yml
    - .cerber/contracts/**
    - bin/cerber-guardian
    - src/guardian/**
    - src/core/Orchestrator.ts
    - package.json
    - tsconfig.json

# ============================================
# CI Profiles
# ============================================
profiles:
  dev-fast:
    gates:
      - fast
    tools:
      - actionlint
    description: 'Fast pre-commit check (<2s)'
  
  dev:
    gates:
      - fast
      - heavy
    tools:
      - actionlint
      - zizmor
    description: 'Full development check'
  
  team:
    gates:
      - fast
      - heavy
    tools:
      - actionlint
      - zizmor
      - gitleaks
    description: 'Team CI with secrets scanning'
    codeowners: true
    protectedBranch: true

# ============================================
# Drift Detection Settings
# ============================================
driftDetection:
  enabled: true
  checkOnCI: true
  failOnDrift: true
  reportFormat: markdown
  diffTool: git
  ignoreWhitespace: false

# ============================================
# Branch Protection Requirements
# ============================================
branchProtection:
  mainBranch: main
  requiredChecks:
    - 'lint_and_typecheck'
    - 'build_and_unit'
  optionalChecks:
    - 'cerber_e2e_all_modes'
    - 'npm_package_validation'
  requireUpToDate: true
  requireCodeOwnerReview: true
  allowForcePush: false

# ============================================
# Generation Rules
# ============================================
generation:
  outputDirectory: .
  workflows:
    outputDirectory: .github/workflows
    format: yaml
    includeComments: true
  documentation:
    outputDirectory: .
    format: markdown
    toc: true
  codeowners:
    enabled: true
    outputPath: .github/CODEOWNERS
    onlyTeamMode: true
  autoCommit: false
  autoGeneratedHeader: '<!-- AUTO-GENERATED BY CERBER — DO NOT EDIT -->'
