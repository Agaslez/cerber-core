name: Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build TypeScript
        run: npm run build
      
      - name: Verify dist/ exists
        run: |
          echo "Checking build output..."
          [ -d "dist" ] || (echo "‚ùå dist/ not created!" && exit 1)
          [ -f "dist/index.js" ] || (echo "‚ùå dist/index.js missing!" && exit 1)
          [ -f "dist/index.d.ts" ] || (echo "‚ùå dist/index.d.ts missing!" && exit 1)
          [ -f "dist/cerber/index.js" ] || (echo "‚ùå dist/cerber/index.js missing!" && exit 1)
          [ -f "dist/guardian/index.js" ] || (echo "‚ùå dist/guardian/index.js missing!" && exit 1)
          echo "‚úÖ Build successful - all files present"
      
      - name: Check TypeScript types
        run: npx tsc --noEmit
      
      - name: Test package can be imported (ESM)
        run: |
          node --input-type=module -e "
            import { Cerber } from './dist/cerber/index.js';
            import { Guardian } from './dist/guardian/index.js';
            console.log('‚úÖ ESM imports work');
          "
      
      - name: Run tests (if exists)
        run: npm test || echo "‚ö†Ô∏è No tests configured yet"
        continue-on-error: true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.node-version }}
          path: dist/
          retention-days: 7

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint (if configured)
        run: npm run lint || echo "‚ö†Ô∏è ESLint not configured"
        continue-on-error: true
      
      - name: Check code formatting
        run: |
          echo "Checking for common issues..."
          ! grep -r "console.log" src/ || echo "‚ö†Ô∏è Found console.log in src/"
          ! grep -r "debugger" src/ || echo "‚ö†Ô∏è Found debugger in src/"
          echo "‚úÖ Basic checks passed"

  package-test:
    name: Test Package Installation
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Build package
        run: |
          npm ci
          npm run build
      
      - name: Create tarball
        run: npm pack
      
      - name: Test installation in fresh project
        run: |
          mkdir test-install
          cd test-install
          npm init -y
          npm install ../cerber-core-*.tgz
          
          # Test imports
          node --input-type=module -e "
            import { Cerber } from 'cerber-core/cerber';
            import { Guardian } from 'cerber-core/guardian';
            console.log('‚úÖ Package installs and imports correctly');
          "
      
      - name: Verify CLI commands exist
        run: |
          cd test-install
          [ -f "node_modules/.bin/cerber" ] || (echo "‚ùå cerber CLI missing!" && exit 1)
          [ -f "node_modules/.bin/cerber-guardian" ] || (echo "‚ùå cerber-guardian CLI missing!" && exit 1)
          [ -f "node_modules/.bin/cerber-health" ] || (echo "‚ùå cerber-health CLI missing!" && exit 1)
          echo "‚úÖ All CLI commands present"

  use-cerber-guardian:
    name: üõ°Ô∏è Dogfooding - Use Guardian on Ourselves
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Cerber
        run: npm run build
      
      - name: Create Guardian schema for Cerber Core
        run: |
          cat > CERBER_SCHEMA.js << 'EOF'
          export default {
            name: 'Cerber Core Architecture',
            version: '1.0.0',
            
            requiredFiles: [
              'package.json',
              'tsconfig.json',
              'README.md',
              'LICENSE',
              'SECURITY.md',
              '.gitignore'
            ],
            
            forbiddenPatterns: [
              {
                pattern: /console\.log\(/g,
                locations: ['src/**/*.ts'],
                message: 'Console statements in production code',
                severity: 'error',
                exceptions: ['src/guardian/index.ts', 'src/cerber/index.ts'], // CLI output is OK
                suggestion: 'Remove console.log or use proper logging'
              },
              {
                pattern: /debugger/g,
                locations: ['src/**/*.ts'],
                message: 'Debugger statements',
                severity: 'error'
              },
              {
                pattern: /any/g,
                locations: ['src/**/*.ts'],
                message: 'TypeScript any type (prefer unknown or specific types)',
                severity: 'warning',
                exceptions: ['src/guardian/index.ts', 'src/cerber/index.ts', 'src/types.ts'] // Record<string, any> for details is justified
              }
            ],
            
            requiredImports: {
              'src/cerber/index.ts': ['../types'],
              'src/guardian/index.ts': ['../types']
            }
          };
          EOF
      
      - name: Run Guardian validation on ourselves
        run: |
          node --input-type=module -e "
            import { Guardian } from './dist/guardian/index.js';
            import schema from './CERBER_SCHEMA.js';
            
            const guardian = new Guardian(schema);
            const result = await guardian.validate(process.cwd());
            
            console.log('DEBUG result:', JSON.stringify(result, null, 2));
            
            if (result.valid === false) {
              console.log('‚ùå Guardian found issues in Cerber Core code!');
              process.exit(1);
            }
            
            console.log('‚úÖ Guardian validation passed - Cerber Core code is clean!');
            process.exit(0);
          "

  use-cerber-health:
    name: üîç Dogfooding - Use Cerber Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Cerber
        run: npm run build
      
      - name: Run health checks on Cerber Core
        run: |
          node --input-type=module -e "
            import { Cerber } from './dist/cerber/index.js';
            import { readFileSync, existsSync } from 'fs';
            
            // Health checks for Cerber Core itself
            const checks = [
              // Check package.json integrity
              async () => {
                const pkg = JSON.parse(readFileSync('package.json', 'utf-8'));
                const issues = [];
                
                if (!pkg.name) issues.push({ code: 'NO_NAME', severity: 'critical', message: 'package.json missing name' });
                if (!pkg.version) issues.push({ code: 'NO_VERSION', severity: 'critical', message: 'package.json missing version' });
                if (!pkg.bin) issues.push({ code: 'NO_BIN', severity: 'error', message: 'package.json missing bin commands' });
                
                return issues;
              },
              
              // Check required files exist
              async () => {
                const required = ['README.md', 'LICENSE', 'SECURITY.md', 'tsconfig.json'];
                const issues = [];
                
                for (const file of required) {
                  if (!existsSync(file)) {
                    issues.push({ 
                      code: 'MISSING_FILE', 
                      severity: 'error', 
                      message: \`Required file missing: \${file}\`
                    });
                  }
                }
                
                return issues;
              },
              
              // Check dist/ exists (build output)
              async () => {
                if (!existsSync('dist/index.js')) {
                  return [{ 
                    code: 'NOT_BUILT', 
                    severity: 'critical', 
                    message: 'Package not built - run npm run build'
                  }];
                }
                return [];
              }
            ];
            
            const cerber = new Cerber(checks);
            const result = await cerber.runChecks();
            
            console.log(\`\nüìä Cerber Health Check Results:\`);
            console.log(\`Status: \${result.status}\`);
            console.log(\`Duration: \${result.duration}ms\`);
            
            if (result.status === 'unhealthy') {
              console.log(\`\n‚ùå Cerber Core health check failed!\`);
              process.exit(1);
            }
            
            console.log(\`\n‚úÖ Cerber Core is healthy!\`);
            process.exit(0);
          "

  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [build, lint, package-test, use-cerber-guardian, use-cerber-health]
    if: always()
    
    steps:
      - name: Check all jobs status
        run: |
          echo "üéØ CI/CD Pipeline Summary"
          echo "=========================="
          echo ""
          echo "Build: ${{ needs.build.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Package Test: ${{ needs.package-test.result }}"
          echo "Guardian Dogfooding: ${{ needs.use-cerber-guardian.result }}"
          echo "Cerber Dogfooding: ${{ needs.use-cerber-health.result }}"
          echo ""
          
          if [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.package-test.result }}" != "success" ] || \
             [ "${{ needs.use-cerber-guardian.result }}" != "success" ] || \
             [ "${{ needs.use-cerber-health.result }}" != "success" ]; then
            echo "‚ùå Some checks failed - see details above"
            exit 1
          fi
          
          echo "‚úÖ All checks passed - Cerber Core is ready!"
