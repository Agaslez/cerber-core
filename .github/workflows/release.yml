name: Create Release

# Disabled - releases created manually via gh CLI
# Re-enable by uncommenting the 'on:' section below
# on:
#   push:
#     tags:
#       - 'v*.*.*'

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Verify version matches package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION=${{ steps.version.outputs.version }}
          
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   package.json: $PACKAGE_VERSION"
            echo "   Git tag: $TAG_VERSION"
            exit 1
          fi
          
          echo "âœ… Version matches: $PACKAGE_VERSION"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build package
        run: npm run build
      
      - name: Create distribution tarball
        run: npm pack
      
      - name: Generate changelog from commits
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release - generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.version.outputs.tag }}"
            CHANGELOG=$(git log $PREVIOUS_TAG..${{ steps.version.outputs.tag }} --pretty=format:"- %s (%h)")
          fi
          
          # Save to file to handle multiline
          echo "$CHANGELOG" > CHANGELOG.txt
          
          echo "Generated changelog:"
          cat CHANGELOG.txt
      
      - name: Create release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Cerber Core ${{ steps.version.outputs.version }}
          
          ## ðŸš€ Installation
          
          ```bash
          npm install cerber-core@${{ steps.version.outputs.version }}
          ```
          
          ## ðŸ“¦ What's Included
          
          - **ðŸ›¡ï¸ Guardian 1.0** - Pre-commit architecture validator
          - **ðŸ” Cerber 2.1** - Runtime health diagnostics
          - **âš¡ SOLO** - Automation for solo developers (9 scripts)
          - **ðŸ‘¥ TEAM** - Focus Mode for large codebases (500 LOC context)
          
          ## ðŸ“ Changes in This Release
          
          EOF
          
          cat CHANGELOG.txt >> RELEASE_NOTES.md
          
          cat >> RELEASE_NOTES.md << 'EOF'
          
          ## ðŸ“š Documentation
          
          - [README](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/README.md)
          - [User Journey](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/USER_JOURNEY.md)
          - [SOLO Guide](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/SOLO.md)
          - [TEAM Guide](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/TEAM.md)
          - [Security Policy](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/SECURITY.md)
          - [Troubleshooting](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/docs/TROUBLESHOOTING.md)
          
          ## ðŸ”— Links
          
          - **npm:** https://www.npmjs.com/package/cerber-core
          - **GitHub:** https://github.com/${{ github.repository }}
          - **Issues:** https://github.com/${{ github.repository }}/issues
          - **Discussions:** https://github.com/${{ github.repository }}/discussions
          
          ## ðŸ’ Support
          
          If Cerber Core helps your project, consider:
          - â­ Star the repo
          - ðŸ’° [Sponsor on GitHub](https://github.com/sponsors/Agaslez)
          - â˜• [Buy me a coffee](https://www.buymeacoffee.com/stefanpitek)
          - ðŸ“¢ Share with your team
          
          ## ðŸ™ Thank You
          
          Thank you to everyone who contributed to this release!
          EOF
          
          echo "Release notes:"
          cat RELEASE_NOTES.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Cerber Core ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            cerber-core-${{ steps.version.outputs.version }}.tgz
            LICENSE
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Trigger npm publish workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'publish.yml',
              ref: '${{ steps.version.outputs.tag }}',
              inputs: {
                tag: '${{ steps.version.outputs.tag }}'
              }
            });
            
            console.log('âœ… Triggered npm publish workflow');
      
      - name: Post release summary
        run: |
          echo "ðŸŽ‰ Release Summary"
          echo "=================="
          echo ""
          echo "âœ… Created: ${{ steps.version.outputs.tag }}"
          echo "ðŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "ðŸ“¦ Tarball: cerber-core-${{ steps.version.outputs.version }}.tgz"
          echo ""
          echo "Next steps:"
          echo "  1. npm publish will run automatically"
          echo "  2. Announce on social media"
          echo "  3. Update documentation site (if exists)"
          echo "  4. Notify sponsors/contributors"
