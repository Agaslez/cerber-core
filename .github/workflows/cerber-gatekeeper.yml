# Generated by Cerber init
name: Cerber Health Gatekeeper

on:
  workflow_call:
    inputs:
      health_url:
        description: 'Health check endpoint URL'
        required: true
        type: string
      wait_seconds:
        description: 'Seconds to wait before checking'
        required: false
        type: number
        default: 90
      fail_on_error:
        description: 'Fail workflow on error-level issues'
        required: false
        type: boolean
        default: true
      fail_on_warning:
        description: 'Fail workflow on warning-level issues'
        required: false
        type: boolean
        default: false
    secrets:
      HEALTH_AUTH_HEADER:
        description: 'Optional Authorization header value'
        required: false

jobs:
  health-check:
    name: Post-Deploy Health Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for deployment to stabilize
        run: sleep ${{ inputs.wait_seconds }}
      
      - name: Check production health
        id: health
        run: |
          echo "Checking health at: ${{ inputs.health_url }}"
          
          # Build curl command with optional auth header
          CURL_CMD="curl -s -f"
          if [ -n "${{ secrets.HEALTH_AUTH_HEADER }}" ]; then
            CURL_CMD="$CURL_CMD -H 'Authorization: ${{ secrets.HEALTH_AUTH_HEADER }}'"
          fi
          
          # Fetch health status
          RESPONSE=$(eval "$CURL_CMD ${{ inputs.health_url }}")
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "❌ Failed to fetch health endpoint"
            echo "response={\"error\": \"connection_failed\"}" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "$RESPONSE" | jq '.'
      
      - name: Validate health status
        run: |
          RESPONSE='${{ steps.health.outputs.response }}'
          
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
          CRITICAL=$(echo "$RESPONSE" | jq -r '.summary.criticalIssues // 0')
          ERRORS=$(echo "$RESPONSE" | jq -r '.summary.errorIssues // 0')
          WARNINGS=$(echo "$RESPONSE" | jq -r '.summary.warningIssues // 0')
          
          echo "Health Status: $STATUS"
          echo "Critical Issues: $CRITICAL"
          echo "Error Issues: $ERRORS"
          echo "Warning Issues: $WARNINGS"
          
          # Check critical issues (always fail)
          if [[ "$CRITICAL" != "0" ]]; then
            echo "❌ DEPLOYMENT BLOCKED - Critical issues detected"
            echo "$RESPONSE" | jq '.components[] | select(.severity == "critical")'
            exit 1
          fi
          
          # Check error issues (configurable)
          if [[ "${{ inputs.fail_on_error }}" == "true" ]] && [[ "$ERRORS" != "0" ]]; then
            echo "❌ DEPLOYMENT BLOCKED - Error issues detected"
            echo "$RESPONSE" | jq '.components[] | select(.severity == "error")'
            exit 1
          fi
          
          # Check warning issues (configurable)
          if [[ "${{ inputs.fail_on_warning }}" == "true" ]] && [[ "$WARNINGS" != "0" ]]; then
            echo "⚠️  DEPLOYMENT BLOCKED - Warning issues detected"
            echo "$RESPONSE" | jq '.components[] | select(.severity == "warning")'
            exit 1
          fi
          
          echo "✅ Production health check passed"
          echo "Status: $STATUS"
