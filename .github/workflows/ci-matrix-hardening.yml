name: Hardening Pack - Cross-Platform Matrix

on:
  push:
    branches: [main, develop, rcx-hardening]
  pull_request:
    branches: [main, develop, rcx-hardening]

jobs:
  matrix-test:
    name: test:release on ${{ matrix.os }} / Node ${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    concurrency:
      group: test-release-${{ matrix.os }}-${{ matrix.node-version }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18', '20', '22']
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-node@v4.0.0
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - run: npm ci
      
      - name: Lint (gate 1)
        run: npm run lint -- --max-warnings 69
      
      - name: Build (gate 2)
        run: npm run build
      
      - name: Hardening Pack Tests (gate 5)
        run: npm run test:release
        timeout-minutes: 10
      
      - name: Package Integrity (gate 4)
        run: npm pack --dry-run

      - name: E2E Pack Install (ubuntu-only) (gate 6)
        if: runner.os == 'Linux'
        run: npm run test:e2e:pack
        timeout-minutes: 15

  # RCX Hardening Tests
  rcx-hardening:
    name: RCX Hardening Suite
    if: github.ref == 'refs/heads/rcx-hardening'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: rcx-hardening-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-node@v4.0.0
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      
      - name: Lint (gate 1)
        run: npm run lint -- --max-warnings 69
      
      - name: Build (gate 2)
        run: npm run build
      
      - name: RCX Hardening Tests (contract-tamper, protected-files, exit-code, tool-detection, concurrency, schema-guard, no-runaway, npm-pack)
        run: npm run test:rcx
        timeout-minutes: 15

  # Separate job for pervasive/slow tests
  brutal-tests:
    name: Brutal Mode Tests
    if: github.ref == 'refs/heads/rcx-hardening'
    runs-on: ubuntu-latest
    timeout-minutes: 40
    concurrency:
      group: brutal-tests-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-node@v4.0.0
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      
      - name: Hostile Filesystem
        run: npm test -- test/integration/fs-hostile.test.ts
        timeout-minutes: 10
      
      - name: Property-Based Fuzz
        run: npm test -- test/fuzz/property-parsers.test.ts
        timeout-minutes: 20
      
      - name: Time Bombs (Fake Timers)
        run: npm test -- test/core/time-bombs.test.ts
        timeout-minutes: 10
      
      - name: Huge Repo Performance
        run: npm test -- test/perf/huge-repo.test.ts
        timeout-minutes: 15
      
      - name: Contract Corruption
        run: npm test -- test/contract/corruption.test.ts
        timeout-minutes: 10
      
      - name: Package Integrity Deep
        run: npm test -- test/e2e/package-integrity.test.ts
        timeout-minutes: 10

  # Signal handling (must be on unix-like)
  signal-tests:
    name: CLI Signal Handling
    if: github.ref == 'refs/heads/rcx-hardening'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: signal-tests-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-node@v4.0.0
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      
      - name: Signal Tests (SIGINT/SIGTERM)
        run: npm test -- test/e2e/cli-signals-refactored.test.ts
        timeout-minutes: 5

      - name: Open Handles Detection (timer/resource leaks)
        run: npm test -- --detectOpenHandles --runInBand --testTimeout 10000
        timeout-minutes: 15
